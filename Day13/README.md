TODO: Refactor this spaghetti mess.
